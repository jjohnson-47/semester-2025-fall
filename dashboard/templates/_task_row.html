<!-- Task Row with Dependency Support and HTMX Out-of-Band Swaps -->
<tr id="task-{{ task.id }}" 
    class="task-row border-b hover:bg-gray-50 
           {% if task.status == 'blocked' %}task-blocked{% endif %}
           {% if task.status == 'done' %}task-done{% endif %}
           priority-{{ task.priority }}
           {% if task.parent_id %}task-child{% endif %}"
    {% if oob %}hx-swap-oob="true"{% endif %}>
    
    <!-- Task Title Column -->
    <td class="px-6 py-4">
        <div class="flex items-center">
            <!-- Chevron for parent tasks with children -->
            {% if task.children|length > 0 %}
                <button onclick="toggleChildren('{{ task.id }}')"
                        class="chevron mr-2 text-gray-400 hover:text-gray-600"
                        id="chevron-{{ task.id }}">
                    ▶
                </button>
            {% else %}
                <span class="mr-6"></span>
            {% endif %}
            
            <!-- Task title and metadata -->
            <div class="flex-1">
                <div class="flex items-center">
                    <span class="task-title font-medium text-gray-900">
                        {{ task.title }}
                    </span>
                    
                    <!-- Dependency lock indicator -->
                    {% if task.status == 'blocked' and task.depends_on %}
                        <span class="lock-icon ml-2" 
                              title="Blocked by: {{ task.blocker_titles|join(', ') }}">
                            🔒
                        </span>
                    {% endif %}
                </div>
                
                <!-- Course and category badges -->
                <div class="mt-1">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        {{ task.course }}
                    </span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 ml-1">
                        {{ task.category }}
                    </span>
                    {% if task.assignee %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 ml-1">
                            @{{ task.assignee }}
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </td>
    
    <!-- Status Column with HTMX Updates -->
    <td class="px-6 py-4">
        <select name="status" 
                class="status-select border rounded px-2 py-1 text-sm"
                {% if task.status == 'blocked' %}disabled{% endif %}
                hx-post="/api/tasks/{{ task.id }}/status"
                hx-trigger="change"
                hx-target="#task-{{ task.id }}"
                hx-swap="outerHTML">
            <option value="blocked" {% if task.status == 'blocked' %}selected{% endif %}>Blocked</option>
            <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>To Do</option>
            <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
            <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
            <option value="deferred" {% if task.status == 'deferred' %}selected{% endif %}>Deferred</option>
        </select>
        
        <!-- Visual status badge -->
        <span class="status-badge status-{{ task.status }} ml-2">
            {{ task.status|replace('_', ' ')|title }}
        </span>
    </td>
    
    <!-- Priority Column -->
    <td class="px-6 py-4">
        <select name="priority"
                class="border rounded px-2 py-1 text-sm"
                hx-post="/api/tasks/{{ task.id }}/priority"
                hx-trigger="change"
                hx-target="#task-{{ task.id }}"
                hx-swap="outerHTML">
            <option value="critical" {% if task.priority == 'critical' %}selected{% endif %}>🔴 Critical</option>
            <option value="high" {% if task.priority == 'high' %}selected{% endif %}>🟠 High</option>
            <option value="medium" {% if task.priority == 'medium' %}selected{% endif %}>🟡 Medium</option>
            <option value="low" {% if task.priority == 'low' %}selected{% endif %}>🟢 Low</option>
        </select>
    </td>
    
    <!-- Due Date Column -->
    <td class="px-6 py-4 text-sm text-gray-500">
        {% if task.due_date %}
            <span class="{% if task.is_overdue %}text-red-600 font-semibold{% endif %}">
                {{ task.due_date|dateformat }}
            </span>
        {% else %}
            <span class="text-gray-400">No due date</span>
        {% endif %}
    </td>
    
    <!-- Actions Column -->
    <td class="px-6 py-4 text-sm">
        <div class="flex space-x-2">
            <!-- Quick complete button -->
            {% if task.status != 'done' and task.status != 'blocked' %}
                <button class="text-green-600 hover:text-green-900"
                        hx-post="/api/tasks/{{ task.id }}/complete"
                        hx-target="#task-{{ task.id }}"
                        hx-swap="outerHTML"
                        title="Mark as complete">
                    ✓
                </button>
            {% endif %}
            
            <!-- Edit button -->
            <button class="text-blue-600 hover:text-blue-900"
                    hx-get="/api/tasks/{{ task.id }}/edit"
                    hx-target="#task-{{ task.id }}"
                    hx-swap="outerHTML"
                    title="Edit task">
                ✏️
            </button>
            
            <!-- View dependencies -->
            {% if task.depends_on or task.blocks %}
                <button class="text-purple-600 hover:text-purple-900"
                        hx-get="/api/tasks/{{ task.id }}/dependencies"
                        hx-target="#modal-content"
                        hx-trigger="click"
                        title="View dependencies">
                    🔗
                </button>
            {% endif %}
            
            <!-- Delete button -->
            <button class="text-red-600 hover:text-red-900"
                    hx-delete="/api/tasks/{{ task.id }}"
                    hx-confirm="Are you sure you want to delete this task?"
                    hx-target="#task-{{ task.id }}"
                    hx-swap="outerHTML swap:1s"
                    title="Delete task">
                    🗑️
            </button>
        </div>
    </td>
</tr>

<!-- If this task has children that should be shown -->
{% if task.children and show_children %}
    {% for child in task.children %}
        {% set task = child %}
        {% include '_task_row.html' %}
    {% endfor %}
{% endif %}